{{- if .Values.dashboards.serviceHealth.enabled }}
apiVersion: datadoghq.com/v1alpha1
kind: DatadogDashboard
metadata:
  name: {{ include "dashboards.serviceName" . }}-service-health
  labels:
    service: {{ include "dashboards.serviceName" . }}
    dashboard-type: service-health
spec:
  title: "Service Health: {{ include "dashboards.serviceName" . }}"
  description: "RED metrics and SRE Golden Signals for {{ include "dashboards.serviceName" . }}"
  experienceType: default
  widgets: '[{"id":522052036166178,"definition":{"title":"Tier 1: Business Value & User Experience","type":"group","layout_type":"ordered","widgets":[{"id":4440595680388601,"definition":{"title":"Throughput (Total Requests)","title_size":"16","title_align":"left","show_legend":false,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"hits","query":"avg:trace.http.request.hits{service:{{ include "dashboards.serviceName" . }},env:{{ .Values.environment }}}.as_count()"}],"formulas":[{"formula":"hits"}],"style":{"palette":"dog_classic","has_value_labels":true,"line_type":"solid","line_width":"normal"},"display_type":"bars"}]}},{"id":7104299246231313,"definition":{"title":"Throughput (Total Errors)","show_legend":false,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"data_source":"metrics","name":"query1","query":"sum:trace.http.request.errors{service:{{ include "dashboards.serviceName" . }},env:{{ .Values.environment }}}.as_count()"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","has_value_labels":true,"line_type":"solid","line_width":"normal"},"display_type":"bars"}]}}]}},{"id":6815765402218107,"definition":{"title":"Tier 2: The RED Pattern (SRE Golden Signals)","type":"group","layout_type":"ordered","widgets":[{"id":3654702661158081,"definition":{"title":"Rate: Requests Per Second (vs Last Week)","show_legend":false,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"time":{"type":"live","unit":"day","value":1},"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"sum:trace.http.request.hits{service:{{ include "dashboards.serviceName" . }},env:{{ .Values.environment }}}.as_count()"}],"formulas":[{"formula":"query1"}],"style":{"palette":"orange","line_type":"solid","line_width":"normal"},"display_type":"line"},{"on_right_yaxis":false,"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"sum:trace.http.request.hits{service:{{ include "dashboards.serviceName" . }},env:{{ .Values.environment }}}.as_rate()"}],"formulas":[{"formula":"hour_before(query1)"}],"style":{"palette":"cool","color_order":"shuffled","has_value_labels":false,"line_type":"dotted","line_width":"thick"},"display_type":"line"}]}},{"id":4445637810011156,"definition":{"title":"Recent Error Logs","requests":[{"response_format":"event_list","query":{"data_source":"logs_pattern_stream","query_string":"status:error service:{{ include "dashboards.serviceName" . }} env:{{ .Values.environment }}","indexes":[],"clustering_pattern_field_path":"message","group_by":[{"facet":"service"}],"storage":"hot"},"columns":[{"field":"status_line","width":"auto"},{"field":"matches","width":"auto"},{"field":"volume","width":"auto"},{"field":"service","width":"auto"},{"field":"message","width":"auto"}]}],"type":"list_stream"}},{"id":6411349182314219,"definition":{"title":"Errors: 5xx & Failed Spans","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"sum:trace.http.request.errors{service:{{ include "dashboards.serviceName" . }},env:{{ .Values.environment }}}.as_rate()"}],"formulas":[{"formula":"query1"}],"style":{"palette":"red","has_value_labels":true},"display_type":"bars"}]}},{"id":4195739183683379,"definition":{"title":"Duration: P99 Latency vs P50","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"p99:trace.http.request.duration{service:{{ include "dashboards.serviceName" . }},env:{{ .Values.environment }}}"}],"formulas":[{"formula":"query1"}],"style":{"palette":"warm","line_width":"thick"},"display_type":"line"},{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"p50:trace.http.request.duration{service:{{ include "dashboards.serviceName" . }},env:{{ .Values.environment }}}"}],"formulas":[{"formula":"query1"}],"style":{"palette":"grey","line_type":"dotted"},"display_type":"line"}]}}]}},{"id":6817128097909008,"definition":{"title":"Tier 3: Debugging & Saturation (Developer Context)","type":"group","layout_type":"ordered","widgets":[{"id":3400704242471582,"definition":{"title":"Saturation: Top 5 Containers by CPU","time":{"type":"live","unit":"day","value":1},"type":"query_table","requests":[{"queries":[{"data_source":"metrics","name":"query1","query":"avg:kubernetes.cpu.usage.total{service:{{ include "dashboards.serviceName" . }},env:{{ .Values.environment }}} by {pod_name}","aggregator":"avg"}],"response_format":"scalar","sort":{"count":500,"order_by":[{"type":"formula","index":0,"order":"desc"}]},"formulas":[{"cell_display_mode":"bar","formula":"query1"}]}],"has_search_bar":"auto"}}]}}]'
  templateVariables:
    - name: env
      prefix: env
      availableValues: []
      defaults:
        - {{ .Values.environment }}
    - name: service
      prefix: service
      availableValues: []
      defaults:
        - {{ include "dashboards.serviceName" . }}
  layoutType: ordered
  notifyList: []
  pauseAutoRefresh: false
  reflowType: auto
{{- end }}
