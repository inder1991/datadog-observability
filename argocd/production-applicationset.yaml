apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: datadog-production-fleet
  namespace: argocd
  labels:
    component: fleet
    env: production
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  
  generators:
    # Two-phase deployment: operator then agents
    - matrix:
        generators:
          # Component: operator or agent
          - list:
              elements:
                - component: operator
                  path: operator/base
                  wave: 0
                  helmValues: |
                    - values-base.yaml
                    - ../overlays/production/values-production.yaml
                  
                - component: agent
                  path: agents/production/{{region}}
                  wave: 10
                  helmValues: ""
          
          # Regions
          - list:
              elements:
                - region: region1
                  cluster: prod-cluster-1
                  server: https://api.prod-cluster-1.example.com:6443
                  datacenter: datacenter-1
                  
                - region: region2
                  cluster: prod-cluster-2
                  server: https://api.prod-cluster-2.example.com:6443
                  datacenter: datacenter-2
                  
                - region: region3
                  cluster: prod-cluster-3
                  server: https://api.prod-cluster-3.example.com:6443
                  datacenter: datacenter-3
  
  template:
    metadata:
      name: 'datadog-{{.component}}-{{.cluster}}'
      labels:
        component: '{{.component}}'
        env: production
        region: '{{.region}}'
        cluster: '{{.cluster}}'
      annotations:
        argocd.argoproj.io/sync-wave: '{{.wave}}'
        notifications.argoproj.io/subscribe.on-sync-failed.slack: platform-engineering-alerts
        notifications.argoproj.io/subscribe.on-sync-succeeded.slack: platform-engineering
    
    spec:
      project: platform-observability
      
      source:
        repoURL: https://github.com/your-org/datadog-operator-deployment.git  # CHANGE THIS
        targetRevision: main
        path: '{{.path}}'
        {{- if eq .component "operator" }}
        helm:
          releaseName: datadog-operator
          valueFiles: {{.helmValues}}
        {{- end }}
      
      destination:
        server: '{{.server}}'
        namespace: '{{if eq .component "operator"}}datadog-operator{{else}}datadog{{end}}'
      
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          {{- if eq .component "operator" }}
          - ServerSideApply=true
          {{- end }}
        retry:
          limit: 5
          backoff:
            duration: 5s
            maxDuration: 3m
